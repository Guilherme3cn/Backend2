"use strict";(()=>{var e={};e.id=635,e.ids=[635],e.modules={399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},9751:(e,t,r)=>{r.r(t),r.d(t,{originalPathname:()=>f,patchFetch:()=>m,requestAsyncStorage:()=>h,routeModule:()=>l,serverHooks:()=>y,staticGenerationAsyncStorage:()=>p});var n={};r.r(n),r.d(n,{GET:()=>d,dynamic:()=>u});var a=r(9303),o=r(8716),s=r(670),i=r(7070),c=r(1982);let u="force-dynamic";async function d(e,{params:t}){try{let r=e.nextUrl.searchParams.get("uid")??e.headers.get("x-tuya-uid")??void 0,n=(0,c.Ms)(r??void 0),a=await (0,c.A0)(t.deviceId,n),o=i.NextResponse.json({uid:n,deviceId:t.deviceId,energy:{powerW:a.powerW,voltageV:a.voltageV,currentA:a.currentA,ts:a.ts}});return o.headers.set("x-tuya-energy-source",a.source),"mock"===a.source&&o.headers.set("x-tuya-energy-note","This device does not expose real-time energy metrics. Values are simulated."),o}catch(e){if(e instanceof c.hq)return i.NextResponse.json({error:e.message,detail:e.detail},{status:400});return console.error("[tuya][energy]",e),i.NextResponse.json({error:"Unexpected error while fetching device energy usage"},{status:500})}}let l=new a.AppRouteRouteModule({definition:{kind:o.x.APP_ROUTE,page:"/api/tuya/energy/[deviceId]/route",pathname:"/api/tuya/energy/[deviceId]",filename:"route",bundlePath:"app/api/tuya/energy/[deviceId]/route"},resolvedPagePath:"C:\\BackendEcoHome\\backend\\app\\api\\tuya\\energy\\[deviceId]\\route.ts",nextConfigOutput:"",userland:n}),{requestAsyncStorage:h,staticGenerationAsyncStorage:p,serverHooks:y}=l,f="/api/tuya/energy/[deviceId]/route";function m(){return(0,s.patchFetch)({serverHooks:y,staticGenerationAsyncStorage:p})}},1982:(e,t,r)=>{r.d(t,{hq:()=>i,Oh:()=>_,p$:()=>h,PW:()=>m,A0:()=>v,lR:()=>g,RJ:()=>d,Ms:()=>f,xf:()=>T});let n=require("crypto");var a=r.n(n);class o{get(e){return this.store.get(e)}set(e){this.store.set(e.uid,e)}update(e,t){let r=this.store.get(e);if(!r)throw Error(`No credential found for uid ${e}`);let n={...r,...t,uid:e,updatedAt:Date.now()};return this.store.set(e,n),n}delete(e){this.store.delete(e)}list(){return Array.from(this.store.values())}constructor(){this.store=new Map}}let s=new o;class i extends Error{constructor(e,t,r){super(e),this.code=t,this.detail=r,this.name="TuyaApiError"}}let c=null;function u(e){let t=process.env[e];return t?.trim()||void 0}function d(){if(c)return c;let e=u("TUYA_CLIENT_ID"),t=u("TUYA_CLIENT_SECRET"),r=u("TUYA_REGION_BASE_URL"),n=u("TUYA_CALLBACK_URL"),a=u("BACKEND_URL"),o=u("TUYA_H5_LOGIN_URL");if(!e||!t||!r||!n)throw Error("Missing Tuya configuration. Please ensure TUYA_CLIENT_ID, TUYA_CLIENT_SECRET, TUYA_REGION_BASE_URL, and TUYA_CALLBACK_URL are set.");return c={clientId:e,clientSecret:t,baseUrl:r,callbackUrl:n,authKey:u("TUYA_AUTH_KEY"),projectCode:u("TUYA_PROJECT_CODE"),backendUrl:a,h5LoginUrl:o}}async function l(e){let t=d(),r=(e.method??"GET").toUpperCase(),n=function(e={}){let t=new URLSearchParams;for(let[r,n]of Object.entries(e))null!=n&&t.append(r,String(n));let r=t.toString();return r.length>0?`?${r}`:""}(e.query),o=`${t.baseUrl}${e.path}${n}`,s=Date.now().toString(),c=a().randomUUID().replace(/-/g,""),u=void 0!==e.body?JSON.stringify(e.body):"",l=[r,a().createHash("sha256").update(u).digest("hex"),"",`${e.path}${n}`].join("\n"),h=`${t.clientId}${e.accessToken??""}${s}${c}${l}`,p=a().createHmac("sha256",t.clientSecret).update(h).digest("hex").toUpperCase(),y={"Content-Type":"application/json",client_id:t.clientId,sign:p,sign_method:"HMAC-SHA256",t:s,nonce:c,lang:"en"};e.accessToken&&(y.access_token=e.accessToken),t.authKey&&(y["Security-AuthKey"]=t.authKey);let f=await fetch(o,{method:r,headers:y,body:u||void 0});if(!f.ok){let e=await f.text();throw new i(`Tuya API request failed with status ${f.status}`,f.status,e)}let m=await f.json();if(!m.success)throw new i(m.msg||"Tuya API error",m.code,m);return m.result}async function h(e){let t=d();return function(e){let t=1e3*e.expire_time,r={uid:e.uid,accessToken:e.access_token,refreshToken:e.refresh_token,expiresAt:Date.now()+t,createdAt:Date.now(),updatedAt:Date.now()};return s.set(r),r}(await l({path:"/v1.0/token",method:"POST",query:{grant_type:1},body:{code:e,redirect_uri:t.callbackUrl}}))}async function p(e){let t=s.get(e);if(!t)throw new i(`No stored credentials for uid ${e}`);let r=await l({path:`/v1.0/token/${t.refreshToken}`,method:"GET",query:{grant_type:2}});return s.update(e,{accessToken:r.access_token,refreshToken:r.refresh_token,expiresAt:Date.now()+1e3*r.expire_time}).accessToken}async function y(e){let t=s.get(e);if(!t)throw new i(`No stored credentials for uid ${e}`);return t.expiresAt-6e4<=Date.now()?p(e):t.accessToken}function f(e){if(e)return e;let t=s.list();if(1===t.length)return t[0].uid;if(0===t.length)throw new i("No linked Tuya accounts found. Complete the OAuth flow first.");throw new i("Multiple Tuya accounts linked. Specify the uid query parameter.")}async function m(e){let t=await y(e);return(await l({path:`/v1.0/users/${e}/devices`,method:"GET",accessToken:t})).map(e=>({id:e.id,name:e.name,category:e.category,online:e.online,icon:e.icon}))}async function g(e,t){let r=await y(t),n=await l({path:`/v1.0/devices/${e}/status`,method:"GET",accessToken:r}),a=n.find(e=>"switch_1"===e.code)??n.find(e=>"switch"===e.code)??n.find(e=>"switch_led"===e.code);return{on:!!a?.value,raw:n}}function w(e,t){let r=Number(e);return Number.isFinite(r)?r:t}async function v(e,t){let r=await y(t),n=await l({path:`/v1.0/devices/${e}/status`,method:"GET",accessToken:r}),a=n.find(e=>"cur_current"===e.code||"cur_power"===e.code),o=n.find(e=>"cur_voltage"===e.code);if(!a&&!o)return function(){let e=Date.now(),t=Number((120*Math.random()+5).toFixed(2)),r=Number((110+5*Math.random()).toFixed(2)),n=Number((t/r).toFixed(2));return{powerW:t,voltageV:r,currentA:n,ts:e,source:"mock"}}();let s=w(a?.value,0),i=w(o?.value,120),c=0!==i?Number((s/i).toFixed(2)):0;return{powerW:s,voltageV:i,currentA:c,ts:Date.now(),source:"tuya"}}async function T(e,t,r){return l({path:`/v1.0/devices/${e}/commands`,method:"POST",accessToken:await y(t),body:{commands:[{code:r.code??"switch",value:r.value}]}})}function _(e){let t=d(),r=t.h5LoginUrl?new URL(t.h5LoginUrl):new URL("/v1.0/oauth/authorize",t.baseUrl);return r.searchParams.set("client_id",t.clientId),r.searchParams.set("redirect_uri",t.callbackUrl),r.searchParams.set("response_type","code"),r.searchParams.set("scope","all"),r.searchParams.set("lang","en"),r.searchParams.set("state",e??a().randomUUID()),r.toString()}}};var t=require("../../../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),n=t.X(0,[948,972],()=>r(9751));module.exports=n})();