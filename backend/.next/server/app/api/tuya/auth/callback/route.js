"use strict";(()=>{var e={};e.id=304,e.ids=[304],e.modules={399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},5927:(e,t,r)=>{r.r(t),r.d(t,{originalPathname:()=>m,patchFetch:()=>w,requestAsyncStorage:()=>h,routeModule:()=>l,serverHooks:()=>f,staticGenerationAsyncStorage:()=>p});var a={};r.r(a),r.d(a,{GET:()=>d});var n=r(9303),s=r(8716),o=r(670),i=r(7070),c=r(1982);let u=process.env.TUYA_APP_DEEP_LINK;async function d(e){(0,c.RJ)();let t=e.nextUrl.searchParams,r=t.get("code"),a=t.get("state")??void 0;if(!r)return i.NextResponse.json({error:"Missing authorization code"},{status:400});try{let t=await (0,c.p$)(r),n=(0,c.RJ)();if(u){let e=new URL(u);return e.searchParams.set("uid",t.uid),a&&e.searchParams.set("state",a),i.NextResponse.redirect(e.toString())}let s=n.backendUrl??e.nextUrl.origin,o=new URL("/connected",s);return o.searchParams.set("uid",t.uid),a&&o.searchParams.set("state",a),i.NextResponse.redirect(o.toString())}catch(e){return console.error("[tuya][callback]",e),i.NextResponse.json({error:"Unable to exchange Tuya authorization code"},{status:500})}}let l=new n.AppRouteRouteModule({definition:{kind:s.x.APP_ROUTE,page:"/api/tuya/auth/callback/route",pathname:"/api/tuya/auth/callback",filename:"route",bundlePath:"app/api/tuya/auth/callback/route"},resolvedPagePath:"C:\\BackendEcoHome\\backend\\app\\api\\tuya\\auth\\callback\\route.ts",nextConfigOutput:"",userland:a}),{requestAsyncStorage:h,staticGenerationAsyncStorage:p,serverHooks:f}=l,m="/api/tuya/auth/callback/route";function w(){return(0,o.patchFetch)({serverHooks:f,staticGenerationAsyncStorage:p})}},1982:(e,t,r)=>{r.d(t,{hq:()=>i,Oh:()=>A,p$:()=>h,PW:()=>w,A0:()=>_,lR:()=>y,RJ:()=>d,Ms:()=>m,xf:()=>g});let a=require("crypto");var n=r.n(a);class s{get(e){return this.store.get(e)}set(e){this.store.set(e.uid,e)}update(e,t){let r=this.store.get(e);if(!r)throw Error(`No credential found for uid ${e}`);let a={...r,...t,uid:e,updatedAt:Date.now()};return this.store.set(e,a),a}delete(e){this.store.delete(e)}list(){return Array.from(this.store.values())}constructor(){this.store=new Map}}let o=new s;class i extends Error{constructor(e,t,r){super(e),this.code=t,this.detail=r,this.name="TuyaApiError"}}let c=null;function u(e){let t=process.env[e];return t?.trim()||void 0}function d(){if(c)return c;let e=u("TUYA_CLIENT_ID"),t=u("TUYA_CLIENT_SECRET"),r=u("TUYA_REGION_BASE_URL"),a=u("TUYA_CALLBACK_URL"),n=u("BACKEND_URL");if(!e||!t||!r||!a)throw Error("Missing Tuya configuration. Please ensure TUYA_CLIENT_ID, TUYA_CLIENT_SECRET, TUYA_REGION_BASE_URL, and TUYA_CALLBACK_URL are set.");return c={clientId:e,clientSecret:t,baseUrl:r,callbackUrl:a,authKey:u("TUYA_AUTH_KEY"),projectCode:u("TUYA_PROJECT_CODE"),backendUrl:n}}async function l(e){let t=d(),r=(e.method??"GET").toUpperCase(),a=function(e={}){let t=new URLSearchParams;for(let[r,a]of Object.entries(e))null!=a&&t.append(r,String(a));let r=t.toString();return r.length>0?`?${r}`:""}(e.query),s=`${t.baseUrl}${e.path}${a}`,o=Date.now().toString(),c=n().randomUUID().replace(/-/g,""),u=void 0!==e.body?JSON.stringify(e.body):"",l=[r,n().createHash("sha256").update(u).digest("hex"),"",`${e.path}${a}`].join("\n"),h=`${t.clientId}${e.accessToken??""}${o}${c}${l}`,p=n().createHmac("sha256",t.clientSecret).update(h).digest("hex").toUpperCase(),f={"Content-Type":"application/json",client_id:t.clientId,sign:p,sign_method:"HMAC-SHA256",t:o,nonce:c,lang:"en"};e.accessToken&&(f.access_token=e.accessToken),t.authKey&&(f["Security-AuthKey"]=t.authKey);let m=await fetch(s,{method:r,headers:f,body:u||void 0});if(!m.ok){let e=await m.text();throw new i(`Tuya API request failed with status ${m.status}`,m.status,e)}let w=await m.json();if(!w.success)throw new i(w.msg||"Tuya API error",w.code,w);return w.result}async function h(e){let t=d();return function(e){let t=1e3*e.expire_time,r={uid:e.uid,accessToken:e.access_token,refreshToken:e.refresh_token,expiresAt:Date.now()+t,createdAt:Date.now(),updatedAt:Date.now()};return o.set(r),r}(await l({path:"/v1.0/token",method:"POST",query:{grant_type:1},body:{code:e,redirect_uri:t.callbackUrl}}))}async function p(e){let t=o.get(e);if(!t)throw new i(`No stored credentials for uid ${e}`);let r=await l({path:`/v1.0/token/${t.refreshToken}`,method:"GET",query:{grant_type:2}});return o.update(e,{accessToken:r.access_token,refreshToken:r.refresh_token,expiresAt:Date.now()+1e3*r.expire_time}).accessToken}async function f(e){let t=o.get(e);if(!t)throw new i(`No stored credentials for uid ${e}`);return t.expiresAt-6e4<=Date.now()?p(e):t.accessToken}function m(e){if(e)return e;let t=o.list();if(1===t.length)return t[0].uid;if(0===t.length)throw new i("No linked Tuya accounts found. Complete the OAuth flow first.");throw new i("Multiple Tuya accounts linked. Specify the uid query parameter.")}async function w(e){let t=await f(e);return(await l({path:`/v1.0/users/${e}/devices`,method:"GET",accessToken:t})).map(e=>({id:e.id,name:e.name,category:e.category,online:e.online,icon:e.icon}))}async function y(e,t){let r=await f(t),a=await l({path:`/v1.0/devices/${e}/status`,method:"GET",accessToken:r}),n=a.find(e=>"switch_1"===e.code)??a.find(e=>"switch"===e.code)??a.find(e=>"switch_led"===e.code);return{on:!!n?.value,raw:a}}function T(e,t){let r=Number(e);return Number.isFinite(r)?r:t}async function _(e,t){let r=await f(t),a=await l({path:`/v1.0/devices/${e}/status`,method:"GET",accessToken:r}),n=a.find(e=>"cur_current"===e.code||"cur_power"===e.code),s=a.find(e=>"cur_voltage"===e.code);if(!n&&!s)return function(){let e=Date.now(),t=Number((120*Math.random()+5).toFixed(2)),r=Number((110+5*Math.random()).toFixed(2)),a=Number((t/r).toFixed(2));return{powerW:t,voltageV:r,currentA:a,ts:e,source:"mock"}}();let o=T(n?.value,0),i=T(s?.value,120),c=0!==i?Number((o/i).toFixed(2)):0;return{powerW:o,voltageV:i,currentA:c,ts:Date.now(),source:"tuya"}}async function g(e,t,r){return l({path:`/v1.0/devices/${e}/commands`,method:"POST",accessToken:await f(t),body:{commands:[{code:r.code??"switch",value:r.value}]}})}function A(e){let t=d(),r=new URL("/v1.0/login/auth",t.baseUrl);return r.searchParams.set("client_id",t.clientId),r.searchParams.set("response_type","code"),r.searchParams.set("redirect_uri",t.callbackUrl),r.searchParams.set("lang","en"),r.searchParams.set("scope","all"),e&&r.searchParams.set("state",e),r.toString()}}};var t=require("../../../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),a=t.X(0,[948,972],()=>r(5927));module.exports=a})();