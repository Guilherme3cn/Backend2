"use strict";(()=>{var e={};e.id=92,e.ids=[92],e.modules={399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},6386:(e,t,r)=>{r.r(t),r.d(t,{originalPathname:()=>m,patchFetch:()=>w,requestAsyncStorage:()=>h,routeModule:()=>l,serverHooks:()=>f,staticGenerationAsyncStorage:()=>p});var a={};r.r(a),r.d(a,{GET:()=>d,dynamic:()=>u});var n=r(9303),o=r(8716),s=r(670),i=r(7070),c=r(1982);let u="force-dynamic";async function d(e){try{let t=e.nextUrl.searchParams.get("uid")??e.headers.get("x-tuya-uid")??void 0,r=(0,c.Ms)(t??void 0),a=await (0,c.PW)(r);return i.NextResponse.json({uid:r,devices:a})}catch(e){if(e instanceof c.hq)return i.NextResponse.json({error:e.message,detail:e.detail},{status:400});return console.error("[tuya][devices]",e),i.NextResponse.json({error:"Unexpected error while fetching Tuya devices"},{status:500})}}let l=new n.AppRouteRouteModule({definition:{kind:o.x.APP_ROUTE,page:"/api/tuya/devices/route",pathname:"/api/tuya/devices",filename:"route",bundlePath:"app/api/tuya/devices/route"},resolvedPagePath:"C:\\BackendEcoHome\\backend\\app\\api\\tuya\\devices\\route.ts",nextConfigOutput:"",userland:a}),{requestAsyncStorage:h,staticGenerationAsyncStorage:p,serverHooks:f}=l,m="/api/tuya/devices/route";function w(){return(0,s.patchFetch)({serverHooks:f,staticGenerationAsyncStorage:p})}},1982:(e,t,r)=>{r.d(t,{hq:()=>i,Oh:()=>g,p$:()=>h,PW:()=>w,A0:()=>_,lR:()=>y,RJ:()=>d,Ms:()=>m,xf:()=>v});let a=require("crypto");var n=r.n(a);class o{get(e){return this.store.get(e)}set(e){this.store.set(e.uid,e)}update(e,t){let r=this.store.get(e);if(!r)throw Error(`No credential found for uid ${e}`);let a={...r,...t,uid:e,updatedAt:Date.now()};return this.store.set(e,a),a}delete(e){this.store.delete(e)}list(){return Array.from(this.store.values())}constructor(){this.store=new Map}}let s=new o;class i extends Error{constructor(e,t,r){super(e),this.code=t,this.detail=r,this.name="TuyaApiError"}}let c=null;function u(e){let t=process.env[e];return t?.trim()||void 0}function d(){if(c)return c;let e=u("TUYA_CLIENT_ID"),t=u("TUYA_CLIENT_SECRET"),r=u("TUYA_REGION_BASE_URL"),a=u("TUYA_CALLBACK_URL"),n=u("BACKEND_URL"),o=u("TUYA_H5_LOGIN_URL");if(!e||!t||!r||!a)throw Error("Missing Tuya configuration. Please ensure TUYA_CLIENT_ID, TUYA_CLIENT_SECRET, TUYA_REGION_BASE_URL, and TUYA_CALLBACK_URL are set.");return c={clientId:e,clientSecret:t,baseUrl:r,callbackUrl:a,authKey:u("TUYA_AUTH_KEY"),projectCode:u("TUYA_PROJECT_CODE"),backendUrl:n,h5LoginUrl:o}}async function l(e){let t=d(),r=(e.method??"GET").toUpperCase(),a=function(e={}){let t=new URLSearchParams;for(let[r,a]of Object.entries(e))null!=a&&t.append(r,String(a));let r=t.toString();return r.length>0?`?${r}`:""}(e.query),o=`${t.baseUrl}${e.path}${a}`,s=Date.now().toString(),c=n().randomUUID().replace(/-/g,""),u=void 0!==e.body?JSON.stringify(e.body):"",l=[r,n().createHash("sha256").update(u).digest("hex"),"",`${e.path}${a}`].join("\n"),h=`${t.clientId}${e.accessToken??""}${s}${c}${l}`,p=n().createHmac("sha256",t.clientSecret).update(h).digest("hex").toUpperCase(),f={"Content-Type":"application/json",client_id:t.clientId,sign:p,sign_method:"HMAC-SHA256",t:s,nonce:c,lang:"en"};e.accessToken&&(f.access_token=e.accessToken),t.authKey&&(f["Security-AuthKey"]=t.authKey);let m=await fetch(o,{method:r,headers:f,body:u||void 0});if(!m.ok){let e=await m.text();throw new i(`Tuya API request failed with status ${m.status}`,m.status,e)}let w=await m.json();if(!w.success)throw new i(w.msg||"Tuya API error",w.code,w);return w.result}async function h(e){let t=d();return function(e){let t=1e3*e.expire_time,r={uid:e.uid,accessToken:e.access_token,refreshToken:e.refresh_token,expiresAt:Date.now()+t,createdAt:Date.now(),updatedAt:Date.now()};return s.set(r),r}(await l({path:"/v1.0/token",method:"POST",query:{grant_type:1},body:{code:e,redirect_uri:t.callbackUrl}}))}async function p(e){let t=s.get(e);if(!t)throw new i(`No stored credentials for uid ${e}`);let r=await l({path:`/v1.0/token/${t.refreshToken}`,method:"GET",query:{grant_type:2}});return s.update(e,{accessToken:r.access_token,refreshToken:r.refresh_token,expiresAt:Date.now()+1e3*r.expire_time}).accessToken}async function f(e){let t=s.get(e);if(!t)throw new i(`No stored credentials for uid ${e}`);return t.expiresAt-6e4<=Date.now()?p(e):t.accessToken}function m(e){if(e)return e;let t=s.list();if(1===t.length)return t[0].uid;if(0===t.length)throw new i("No linked Tuya accounts found. Complete the OAuth flow first.");throw new i("Multiple Tuya accounts linked. Specify the uid query parameter.")}async function w(e){let t=await f(e);return(await l({path:`/v1.0/users/${e}/devices`,method:"GET",accessToken:t})).map(e=>({id:e.id,name:e.name,category:e.category,online:e.online,icon:e.icon}))}async function y(e,t){let r=await f(t),a=await l({path:`/v1.0/devices/${e}/status`,method:"GET",accessToken:r}),n=a.find(e=>"switch_1"===e.code)??a.find(e=>"switch"===e.code)??a.find(e=>"switch_led"===e.code);return{on:!!n?.value,raw:a}}function T(e,t){let r=Number(e);return Number.isFinite(r)?r:t}async function _(e,t){let r=await f(t),a=await l({path:`/v1.0/devices/${e}/status`,method:"GET",accessToken:r}),n=a.find(e=>"cur_current"===e.code||"cur_power"===e.code),o=a.find(e=>"cur_voltage"===e.code);if(!n&&!o)return function(){let e=Date.now(),t=Number((120*Math.random()+5).toFixed(2)),r=Number((110+5*Math.random()).toFixed(2)),a=Number((t/r).toFixed(2));return{powerW:t,voltageV:r,currentA:a,ts:e,source:"mock"}}();let s=T(n?.value,0),i=T(o?.value,120),c=0!==i?Number((s/i).toFixed(2)):0;return{powerW:s,voltageV:i,currentA:c,ts:Date.now(),source:"tuya"}}async function v(e,t,r){return l({path:`/v1.0/devices/${e}/commands`,method:"POST",accessToken:await f(t),body:{commands:[{code:r.code??"switch",value:r.value}]}})}function g(e){let t=d(),r=t.h5LoginUrl?new URL(t.h5LoginUrl):new URL("/v1.0/oauth/authorize",t.baseUrl);return r.searchParams.set("client_id",t.clientId),r.searchParams.set("redirect_uri",t.callbackUrl),r.searchParams.set("response_type","code"),r.searchParams.set("scope","all"),r.searchParams.set("lang","en"),r.searchParams.set("state",e??n().randomUUID()),r.toString()}}};var t=require("../../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),a=t.X(0,[948,972],()=>r(6386));module.exports=a})();