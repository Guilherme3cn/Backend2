"use strict";(()=>{var e={};e.id=722,e.ids=[722],e.modules={399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},2733:(e,t,r)=>{r.r(t),r.d(t,{originalPathname:()=>f,patchFetch:()=>m,requestAsyncStorage:()=>l,routeModule:()=>d,serverHooks:()=>p,staticGenerationAsyncStorage:()=>h});var n={};r.r(n),r.d(n,{GET:()=>u});var a=r(9303),o=r(8716),s=r(670),i=r(7070),c=r(1982);function u(e){(0,c.RJ)();let t=e.nextUrl.searchParams.get("state")??void 0,r=(0,c.Oh)(t);return i.NextResponse.redirect(r,{status:302})}let d=new a.AppRouteRouteModule({definition:{kind:o.x.APP_ROUTE,page:"/api/tuya/login/route",pathname:"/api/tuya/login",filename:"route",bundlePath:"app/api/tuya/login/route"},resolvedPagePath:"C:\\BackendEcoHome\\backend\\app\\api\\tuya\\login\\route.ts",nextConfigOutput:"",userland:n}),{requestAsyncStorage:l,staticGenerationAsyncStorage:h,serverHooks:p}=d,f="/api/tuya/login/route";function m(){return(0,s.patchFetch)({serverHooks:p,staticGenerationAsyncStorage:h})}},1982:(e,t,r)=>{r.d(t,{hq:()=>i,Oh:()=>A,p$:()=>h,PW:()=>w,A0:()=>_,lR:()=>y,RJ:()=>d,Ms:()=>m,xf:()=>g});let n=require("crypto");var a=r.n(n);class o{get(e){return this.store.get(e)}set(e){this.store.set(e.uid,e)}update(e,t){let r=this.store.get(e);if(!r)throw Error(`No credential found for uid ${e}`);let n={...r,...t,uid:e,updatedAt:Date.now()};return this.store.set(e,n),n}delete(e){this.store.delete(e)}list(){return Array.from(this.store.values())}constructor(){this.store=new Map}}let s=new o;class i extends Error{constructor(e,t,r){super(e),this.code=t,this.detail=r,this.name="TuyaApiError"}}let c=null;function u(e){let t=process.env[e];return t?.trim()||void 0}function d(){if(c)return c;let e=u("TUYA_CLIENT_ID"),t=u("TUYA_CLIENT_SECRET"),r=u("TUYA_REGION_BASE_URL"),n=u("TUYA_CALLBACK_URL"),a=u("BACKEND_URL");if(!e||!t||!r||!n)throw Error("Missing Tuya configuration. Please ensure TUYA_CLIENT_ID, TUYA_CLIENT_SECRET, TUYA_REGION_BASE_URL, and TUYA_CALLBACK_URL are set.");return c={clientId:e,clientSecret:t,baseUrl:r,callbackUrl:n,authKey:u("TUYA_AUTH_KEY"),projectCode:u("TUYA_PROJECT_CODE"),backendUrl:a}}async function l(e){let t=d(),r=(e.method??"GET").toUpperCase(),n=function(e={}){let t=new URLSearchParams;for(let[r,n]of Object.entries(e))null!=n&&t.append(r,String(n));let r=t.toString();return r.length>0?`?${r}`:""}(e.query),o=`${t.baseUrl}${e.path}${n}`,s=Date.now().toString(),c=a().randomUUID().replace(/-/g,""),u=void 0!==e.body?JSON.stringify(e.body):"",l=[r,a().createHash("sha256").update(u).digest("hex"),"",`${e.path}${n}`].join("\n"),h=`${t.clientId}${e.accessToken??""}${s}${c}${l}`,p=a().createHmac("sha256",t.clientSecret).update(h).digest("hex").toUpperCase(),f={"Content-Type":"application/json",client_id:t.clientId,sign:p,sign_method:"HMAC-SHA256",t:s,nonce:c,lang:"en"};e.accessToken&&(f.access_token=e.accessToken),t.authKey&&(f["Security-AuthKey"]=t.authKey);let m=await fetch(o,{method:r,headers:f,body:u||void 0});if(!m.ok){let e=await m.text();throw new i(`Tuya API request failed with status ${m.status}`,m.status,e)}let w=await m.json();if(!w.success)throw new i(w.msg||"Tuya API error",w.code,w);return w.result}async function h(e){let t=d();return function(e){let t=1e3*e.expire_time,r={uid:e.uid,accessToken:e.access_token,refreshToken:e.refresh_token,expiresAt:Date.now()+t,createdAt:Date.now(),updatedAt:Date.now()};return s.set(r),r}(await l({path:"/v1.0/token",method:"POST",query:{grant_type:1},body:{code:e,redirect_uri:t.callbackUrl}}))}async function p(e){let t=s.get(e);if(!t)throw new i(`No stored credentials for uid ${e}`);let r=await l({path:`/v1.0/token/${t.refreshToken}`,method:"GET",query:{grant_type:2}});return s.update(e,{accessToken:r.access_token,refreshToken:r.refresh_token,expiresAt:Date.now()+1e3*r.expire_time}).accessToken}async function f(e){let t=s.get(e);if(!t)throw new i(`No stored credentials for uid ${e}`);return t.expiresAt-6e4<=Date.now()?p(e):t.accessToken}function m(e){if(e)return e;let t=s.list();if(1===t.length)return t[0].uid;if(0===t.length)throw new i("No linked Tuya accounts found. Complete the OAuth flow first.");throw new i("Multiple Tuya accounts linked. Specify the uid query parameter.")}async function w(e){let t=await f(e);return(await l({path:`/v1.0/users/${e}/devices`,method:"GET",accessToken:t})).map(e=>({id:e.id,name:e.name,category:e.category,online:e.online,icon:e.icon}))}async function y(e,t){let r=await f(t),n=await l({path:`/v1.0/devices/${e}/status`,method:"GET",accessToken:r}),a=n.find(e=>"switch_1"===e.code)??n.find(e=>"switch"===e.code)??n.find(e=>"switch_led"===e.code);return{on:!!a?.value,raw:n}}function T(e,t){let r=Number(e);return Number.isFinite(r)?r:t}async function _(e,t){let r=await f(t),n=await l({path:`/v1.0/devices/${e}/status`,method:"GET",accessToken:r}),a=n.find(e=>"cur_current"===e.code||"cur_power"===e.code),o=n.find(e=>"cur_voltage"===e.code);if(!a&&!o)return function(){let e=Date.now(),t=Number((120*Math.random()+5).toFixed(2)),r=Number((110+5*Math.random()).toFixed(2)),n=Number((t/r).toFixed(2));return{powerW:t,voltageV:r,currentA:n,ts:e,source:"mock"}}();let s=T(a?.value,0),i=T(o?.value,120),c=0!==i?Number((s/i).toFixed(2)):0;return{powerW:s,voltageV:i,currentA:c,ts:Date.now(),source:"tuya"}}async function g(e,t,r){return l({path:`/v1.0/devices/${e}/commands`,method:"POST",accessToken:await f(t),body:{commands:[{code:r.code??"switch",value:r.value}]}})}function A(e){let t=d(),r=new URL("/v1.0/login/auth",t.baseUrl);return r.searchParams.set("client_id",t.clientId),r.searchParams.set("response_type","code"),r.searchParams.set("redirect_uri",t.callbackUrl),r.searchParams.set("lang","en"),r.searchParams.set("scope","all"),e&&r.searchParams.set("state",e),r.toString()}}};var t=require("../../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),n=t.X(0,[948,972],()=>r(2733));module.exports=n})();